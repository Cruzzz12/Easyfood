{% extends 'recipes/base.html' %}

{% block content %}
  <div class="row gx-4">
    <div class="col-md-3">
      <div class="mb-3">
        <div class="detail-image-wrapper mb-3">
          {% if recipe.image %}
            <img src="{{ recipe.image.url }}" class="img-fluid detail-main-img" alt="{{ recipe.title }}" loading="lazy">
          {% else %}
            <div class="no-image-placeholder center-vert" aria-hidden="true">
              <i class="bi bi-image icon-xl"></i>
            </div>
          {% endif %}
        </div>
        <div class="card detail-card">
          <div class="card-body">
            <h3 class="card-title mb-2 detail-title">{{ recipe.title }}</h3>
            <p class="meta-small mb-1"><i class="bi bi-clock me-1"></i>{% if recipe.estimated_time %}{{ recipe.estimated_time }} min{% else %}-{% endif %}</p>
            <p class="meta-small mb-0"><i class="bi bi-person me-1"></i>{% if recipe.author %}{{ recipe.author.username }}{% else %}Anónimo{% endif %}</p>
            <hr>
            <div class="detail-subtext">
              <strong>Valoración:</strong>
              {% if avg_rating %}
                <span class="ms-2">{{ avg_rating|floatformat:1 }} / 5</span>
              {% else %}
                <span class="ms-2 text-muted">Sin valoraciones</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="mb-3">
        <div class="card detail-card">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-file-earmark-text me-2"></i>Descripción</h5>
            <div class="card-text detail-subtext">{{ recipe.description|linebreaksbr }}</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="card detail-card">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-clipboard-check me-2"></i>Preparación</h5>
            <div class="card-text detail-subtext">{{ recipe.preparation|linebreaksbr }}</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="card detail-card">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-images me-2"></i>Pasos</h5>
            {% if steps %}
              <div class="mb-3">
                <div id="stepsCarousel-{{ recipe.pk }}" class="carousel slide steps-carousel" data-bs-ride="carousel">
                  <div class="carousel-inner">
                    {% for s in steps %}
                      <div class="carousel-item {% if forloop.first %}active{% endif %}">
                          {% if s.image %}
                          <img src="{{ s.image.url }}" class="d-block step-main-img clickable" alt="Paso {{ s.order }}" data-step-index="{{ forloop.counter0 }}" data-bs-toggle="modal" data-bs-target="#stepImageModal" loading="lazy">
                        {% else %}
                          <div class="d-flex align-items-center justify-content-center bg-light carousel-no-image">
                            <i class="bi bi-image muted-icon icon-xl"></i>
                          </div>
                        {% endif %}
                        <div class="steps-caption d-none d-md-block">
                          <h6 class="mb-1">Paso {{ s.order }}</h6>
                          <div class="small">{{ s.description|linebreaksbr }}</div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                  <button class="carousel-control-prev" type="button" data-bs-target="#stepsCarousel-{{ recipe.pk }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                  </button>
                  <button class="carousel-control-next" type="button" data-bs-target="#stepsCarousel-{{ recipe.pk }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Siguiente</span>
                  </button>
                </div>

                <div class="steps-thumbnail-row" id="thumbnails-{{ recipe.pk }}">
                  {% for s in steps %}
                      {% if s.image %}
                      <img src="{{ s.image.url }}" class="steps-thumbnail {% if forloop.first %}active-thumb{% endif %}" data-target="#stepsCarousel-{{ recipe.pk }}" data-index="{{ forloop.counter0 }}" alt="Thumb {{ forloop.counter }}" loading="lazy">
                    {% else %}
                      <div class="steps-thumbnail bg-light d-flex align-items-center justify-content-center thumb-placeholder"><i class="bi bi-image thumb-icon-muted"></i></div>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- Modal para ver imagen grande -->
                <div class="modal fade" id="stepImageModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content p-3">
                      <div class="modal-body text-center">
                        <img src="" id="modalStepImage" class="modal-img" alt="Imagen paso">
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% else %}
              <div class="text-muted">Aún no hay pasos agregados.</div>
            {% endif %}

            {% if can_edit %}
              <div class="mt-3 text-end">
                <a class="btn btn-outline-secondary" href="{% url 'recipes:edit' recipe.pk %}">Editar receta para gestionar pasos</a>
              </div>
            {% endif %}
                <script>
                  // Click en miniatura -> desplazar carrusel; actualizar miniatura activa; manejo del modal de imagen
                  (function(){
                    const carouselEl = document.getElementById('stepsCarousel-{{ recipe.pk }}');
                    if(!carouselEl) return;
                    const thumbs = document.querySelectorAll('#thumbnails-{{ recipe.pk }} .steps-thumbnail');
                    const carousel = new bootstrap.Carousel(carouselEl, {interval:false});
                    thumbs.forEach(t => t.addEventListener('click', function(){
                      const idx = parseInt(this.dataset.index);
                      carousel.to(idx);
                    }));

                    // actualizar miniatura activa al cambiar slide
                    carouselEl.addEventListener('slid.bs.carousel', function(e){
                      const idx = e.to;
                      thumbs.forEach(t => t.classList.remove('active-thumb'));
                      const active = document.querySelector('#thumbnails-{{ recipe.pk }} .steps-thumbnail[data-index="'+idx+'"]');
                      if(active) active.classList.add('active-thumb');
                    });

                    // abrir modal con la imagen clicada desde el carrusel
                    carouselEl.addEventListener('click', function(e){
                      const img = e.target.closest('img');
                      if(img && img.dataset.stepIndex !== undefined){
                        const modalImg = document.getElementById('modalStepImage');
                        modalImg.src = img.src;
                      }
                    });
                  })();
                </script>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="card detail-card">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-list-columns me-2"></i>Ingredientes</h5>
            <div class="card-text">{% for i in recipe.ingredients.all %}<span class="ingredient-badge">{{ i.name }}</span>{% empty %}<span class="text-muted">-</span>{% endfor %}</div>
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="card detail-card">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-chat-dots me-2"></i>Comentarios</h5>
            <div id="commentsList">
              {% if comments %}
                {% for c in comments %}
                  <div class="mb-2">
                    <strong>{{ c.author.username }}</strong>
                    <small class="text-muted"> - {{ c.created_at|date:"Y-m-d H:i" }}</small>
                    <div class="mt-1">{{ c.content|linebreaksbr }}</div>
                    <hr>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-muted">Aún no hay comentarios.</div>
              {% endif %}
            </div>

            {% if user.is_authenticated %}
              <form id="commentForm" method="post" action="{% url 'recipes:add_comment' recipe.pk %}">
                {% csrf_token %}
                {{ comment_form.content }}
                <div class="mt-2 d-flex">
                  <button class="btn btn-primary btn-sm ms-auto" type="submit">Publicar comentario</button>
                </div>
              </form>
            {% else %}
              <div class="text-muted"><a href="{% url 'recipes:login' %}">Inicia sesión</a> para escribir un comentario.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2 action-buttons">
        <a href="/" class="btn btn-secondary">Volver</a>
        {% if can_edit %}
          <a href="{% url 'recipes:edit' recipe.pk %}" class="btn btn-primary custom">Editar</a>
          <form method="post" action="{% url 'recipes:delete' recipe.pk %}" class="d-inline ms-2" onsubmit="return confirm('¿Eliminar la receta? Esta acción no se puede deshacer.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger custom">Eliminar</button>
          </form>
        {% endif %}
        {% if user.is_authenticated %}
          <div class="ms-auto d-flex align-items-center">
            <div class="me-2">Calificar:</div>
            <div class="btn-group" role="group" aria-label="rating-detail">
              {% for val in rating_choices %}
                <button type="button" class="btn btn-outline-warning rating-detail-star {% if user_rating and user_rating >= val %}active{% endif %}" data-value="{{ val }}">{{ val }}★</button>
              {% endfor %}
            </div>
          </div>
          <script>
            (function(){
              // Añadir botón para guardar/quitar guardado
              const container = document.querySelector('.d-flex.align-items-center.gap-2');
              if(!container) return;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'btn {% if saved %}btn-primary{% else %}btn-outline-primary{% endif %}';
              btn.id = 'saveToggleBtn';
              btn.textContent = "{% if saved %}Guardada{% else %}Guardar{% endif %}";
              container.appendChild(btn);

              btn.addEventListener('click', async function(){
                const url = '{% url "recipes:toggle_save" recipe.pk %}';
                try{
                  const resp = await fetch(url, {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','X-CSRFToken': getCookie('csrftoken')}, credentials:'same-origin'});
                  const json = await resp.json();
                  if(json && json.success){
                    btn.textContent = json.saved ? 'Guardada' : 'Guardar';
                  }
                }catch(e){ console.error(e); }
              });
            })();
          </script>
          <script>
            (function(){
              const stars = document.querySelectorAll('.rating-detail-star');
              stars.forEach(s => s.addEventListener('click', async function(){
                const val = this.dataset.value;
                const url = '{% url "recipes:rate" recipe.pk %}';
                try{
                  const json = await postRating(url, val);
                  if(json && json.success){
                    // actualizar visualización de la media en la tarjeta izquierda
                    const avgEl = document.querySelector('.card .ms-2');
                    if(avgEl) avgEl.textContent = (json.avg? parseFloat(json.avg).toFixed(1) + ' / 5' : 'Sin valoraciones');
                    stars.forEach(btn => { if(parseInt(btn.dataset.value) <= parseInt(val)) btn.classList.add('active'); else btn.classList.remove('active'); });
                  }
                }catch(e){ console.error(e); }
              }));
            })();
          </script>
        {% else %}
          <div class="ms-auto text-muted">Inicia sesión para calificar</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
